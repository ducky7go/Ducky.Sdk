# Ducky.Sdk - AI Coding Agent Instructions

## Project Overview

**Ducky.Sdk** is a .NET SDK for developing mods for "Escape from Duckov" game using the BetterModLoader framework. It provides:
- A NuGet package containing source generators, MSBuild tasks, and shared libraries
- Automatic localization key generation from constants
- Build-time deployment to game directories
- Strongly-typed mod development patterns

## Architecture

### Repository Structure
- **`Sdk/`** - SDK development workspace with main solution (`Docky.Sdk.slnx`)
  - `SDKlibs/Ducky.Sdk/` - Core NuGet package (`.nuspec`, `.props`, `.targets`)
  - `SDKlibs/Ducky.Sdk.Lib/` - Shared library source code (distributed via contentFiles)
  - `Ducky.Sdk.Analyser/` - Roslyn incremental source generator
  - `Tests/` - Unit tests
- **`Samples/`** - Example mod projects consuming the SDK (`Docky.Sdk.Sample.slnx`)
- **`scripts/`** - Build automation (packToLocal.sh, rebuild_samples.sh, fetch_build_dependency.sh)
- **`duckylocal/`** - Local NuGet feed for testing

### Key Design Pattern: Source-Code Distribution
The SDK uses `<developmentDependency>true</developmentDependency>` in the nuspec and distributes `.cs` files via `contentFiles/cs/netstandard2.1/` rather than compiled assemblies. This allows mod developers to:
- See and debug SDK code directly in their project
- Avoid assembly version conflicts with game assemblies
- Have single-DLL mod outputs without SDK dependencies

## Critical Development Workflows

### Building and Testing SDK Changes

```bash
# 1. Package SDK to local feed (version 0.0.1 for samples)
./scripts/packToLocal.sh --version 0.0.1

# 2. Rebuild samples with fresh SDK
./scripts/rebuild_samples.sh

# 3. For production packaging with custom version
./scripts/packToLocal.sh --version 1.2.3 --configuration Release
```

**Important**: `rebuild_samples.sh` aggressively clears NuGet caches and bin/obj folders to ensure samples use the latest local package.

### Local Development Setup

Mod projects require `Local.props` (git-ignored) to specify game location:

```xml
<!-- Samples/Local.props -->
<Project>
  <PropertyGroup>
    <SteamFolder>/path/to/steam/</SteamFolder>
    <!-- SDK computes: $(DuckovFolder) = $(SteamFolder)steamapps/common/Escape from Duckov/ -->
  </PropertyGroup>
</Project>
```

Without `Local.props`, builds fail with: _"SteamDir property must be set"_ (see `Samples/Directory.Build.props` validation).

### Fetching Game Dependencies

Game assemblies (Unity, TeamSoda, etc.) are not in the repo. Use:

```bash
./scripts/fetch_build_dependency.sh
```

Downloads game DLLs from the `sdk_build_dependency` GitHub releases to `./Managed/`. The SDK's `.props` file dynamically references these via `AddDuckyManagedReferences` target.

## Mod Development Conventions

### ModBehaviour Pattern
Every mod has a class inheriting `ModBehaviourBase` (from SDK):

```csharp
public class ModBehaviour : ModBehaviourBase
{
    protected override void ModEnabled()  { /* Apply patches, register events */ }
    protected override void ModDisabled() { /* Clean up, unpatch */ }
}
```

The SDK base class auto-initializes:
- Logging via `Log.Current = LogProvider.GetLogger(modName)`
- Localization via `L.Instance.SetLanguage(...)`
- Buff registration via `BuffRegistrator.Instance.EnsureBuffIdRegion()`

### Localization System (LK â†’ L Pattern)

1. **Define keys** in a static `LK` class with nested groups:
   ```csharp
   public static class LK
   {
       public static class UI
       {
           public const string NiceWelcomeMessage = "Welcome to Ducky Entrance Mod!";
       }
   }
   ```

2. **Source generator** (`DuckyLocalizationGenerator`) creates matching `L` properties:
   ```csharp
   // Auto-generated partial class L
   public static class UI
   {
       public static string NiceWelcomeMessage => Get(LK.UI.NiceWelcomeMessage);
   }
   ```

3. **CSV files** in `assets/Locales/` (e.g., `en.csv`, `zh.csv`) map keys to translations:
   ```csv
   Key,Value
   Welcome to Ducky Entrance Mod!,Welcome!
   ```

4. **MSBuild task** (`UpdateLocalesCsv` target) validates CSV files contain all keys using `LKeys.All` and `LocalsKeysHash.Hash` generated by the source generator.

### Project Configuration

**Mod entry project** (produces the DLL):
```xml
<PropertyGroup>
  <ModName>Ducky.EntranceMod</ModName>
  <ExcludeSdkLib>true</ExcludeSdkLib> <!-- Don't compile SDK sources directly -->
</PropertyGroup>
<PackageReference Include="Ducky.Sdk" Version="0.0.1">
  <PrivateAssets>all</PrivateAssets> <!-- Build-time only -->
</PackageReference>
```

**Shared library** (for multi-project mods):
```xml
<PropertyGroup>
  <IsModLib>true</IsModLib>
  <AssetsDir>$(SolutionDir)/Ducky.EntranceMod/assets</AssetsDir>
</PropertyGroup>
```

### Build Outputs and Deployment

On build, the SDK's `.targets` file:
1. Copies `assets/` (info.ini, description.md, preview.png, Locales/) to `$(ModsDirectory)$(ModName)/`
2. Copies project DLL to mod folder
3. Copies missing dependencies to `Dependency/` subfolder (DLLs not in game's Managed folder)

Set `<DeployMod>false</DeployMod>` to disable auto-deployment during development.

## Code Patterns and Conventions

### Logging
```csharp
using Ducky.Sdk.Logging;
Log.Info("Message with {Param}", value);  // Structured logging via LibLog
```

### Mod Identity
- `Helper.GetModName()` - Reads `[ModName]` attribute or assembly name
- `Helper.GetModId()` - Returns `ModId` struct: "local.FolderName" for local mods, "steam.WorkshopId" for Steam Workshop

### Configuration Storage
```csharp
using Ducky.Sdk.Options;
// Per-mod config: Application.persistentDataPath/Ducky/ModLocalConfig/ModName.json
ModOptions.ForThis.Set("key", value);
// Shared config: Application.persistentDataPath/Ducky/ModsLocalConfig.json  
ModOptions.ForAllMods.Set("key", value);
```

## Important MSBuild Mechanics

### Target Evaluation Order
1. `InitializeDuckyFolders` (from `.props`) - Computes `$(DuckovFolder)` from `$(SteamFolder)`
2. `AddDuckyManagedReferences` (from `.props`) - Adds game assembly references
3. `CopyToDuckov` (from `.targets`, AfterTargets="Build") - Deploys mod files
4. `UpdateLocalesCsv` (from `.targets`, AfterTargets="AfterBuild") - Validates localization

### ContentFiles Visibility
SDK sources are hidden from Solution Explorer:
```xml
<Compile Update="@(_DuckySdkCompileForVisibility)">
  <Visible>false</Visible>
</Compile>
```

## Testing Strategy

- Unit tests in `Sdk/Tests/Ducky.Sdk.Lib.Tests/`
- Sample projects serve as integration tests (`Samples/Ducky.SingleProject/`, `Samples/Ducky.EntranceMod/`)
- Use `rebuild_samples.sh` to validate end-to-end SDK workflow

## Package Versioning

- **Development**: Always use `0.0.1` for samples (hardcoded in `rebuild_samples.sh`)
- **Production**: Use `--version x.y.z` with `packToLocal.sh` or rely on MinVer in CI (`Directory.Packages.props` includes MinVer when `$(CI) == 'true'`)

## Common Pitfalls

1. **"SteamDir property must be set"** - Create `Samples/Local.props` with `<SteamFolder>`
2. **Stale NuGet cache** - Use `packToLocal.sh --clear-all-caches` or run `rebuild_samples.sh`
3. **Missing game assemblies** - Run `fetch_build_dependency.sh` before building
4. **Localization keys missing in CSV** - Generator creates `LKeys.All` array; MSBuild task validates CSV completeness
5. **Mod not deploying** - Check `$(DeployMod)` property and `$(DuckovFolder)` path validity

## File Naming Conventions

- Source generators output: `L.GeneratedKeys.{Namespace}.g.cs`, `LKeys.{Namespace}.g.cs`
- Mod assets folder: `assets/` (case-sensitive on Linux)
- Localization CSVs: `en.csv`, `zh.csv` (language codes)

## When Modifying the SDK

1. **Analyser changes**: Rebuild `Ducky.Sdk.Analyser` project
2. **Library changes**: Edit files in `SDKlibs/Ducky.Sdk.Lib/` (no rebuild needed, packed as source)
3. **Build logic changes**: Edit `Ducky.Sdk.props` or `Ducky.Sdk.targets`
4. Always test via `./scripts/rebuild_samples.sh` before committing

## External Dependencies

- **Game**: "Escape from Duckov" (Unity game, references via `Managed/` folder)
- **Mod Loader**: BetterModLoader (provides `ModBehaviour` base class)
- **Build Tools**: .NET SDK 9.0 (see `Sdk/global.json`)
- **Package Management**: Central Package Management enabled (`Directory.Packages.props`)
